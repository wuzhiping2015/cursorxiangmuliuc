# 微信小程序开发指令文档（基于uView UI框架 - 掌控习惯小程序）

## 一、技术选型标准
### 1.1 核心框架
- **微信小程序原生框架**：基于微信小程序原生语法进行开发，充分利用其官方提供的组件和接口。
- **兼容处理**：确保代码在不同版本微信客户端的兼容性，针对低版本可能存在的API差异进行适配。

### 1.2 配套技术栈
| 领域          | 技术方案                          | 关键特性                          |
|---------------|-----------------------------------|----------------------------------|
| **UI框架**    | uView UI | 丰富的组件库，支持主题定制、按需引入，具备良好的扩展性和美观性  |
| **数据通信**  | 微信小程序原生 `wx.request` ，可封装拦截器进行统一管理 | 支持与后端接口进行HTTP通信，处理请求和响应  |
| **样式方案**  | WXSS（微信小程序样式表） | 支持变量定义、样式模块化，可配合rpx单位实现适配不同屏幕尺寸  |
| **工具库**    | dayjs、Lodash （按需引入） | 提供日期处理、常用工具函数等功能，优化代码体积  |

## 二、工程架构规范
### 2.1 核心目录结构
```bash
├── pages/                      # 页面文件夹
│   ├── welcome/                # 欢迎页面相关文件
│   │   ├── welcome.wxml        # 欢迎页面结构文件
│   │   ├── welcome.wxss        # 欢迎页面样式文件
│   │   └── welcome.js          # 欢迎页面逻辑文件
│   ├── home/                   # 主页相关文件
│   │   ├── home.wxml           # 主页结构文件
│   │   ├── home.wxss           # 主页样式文件
│   │   └── home.js             # 主页逻辑文件
│   ├── addHabit/               # 添加习惯页面相关文件
│   │   ├── addHabit.wxml       # 添加习惯页面结构文件
│   │   ├── addHabit.wxss       # 添加习惯页面样式文件
│   │   └── addHabit.js         # 添加习惯页面逻辑文件
│   ├── habitDetail/            # 习惯详情页面相关文件
│   │   ├── habitDetail.wxml    # 习惯详情页面结构文件
│   │   ├── habitDetail.wxss    # 习惯详情页面样式文件
│   │   └── habitDetail.js      # 习惯详情页面逻辑文件
│   ├── statistics/             # 统计分析页面相关文件
│   │   ├── statistics.wxml     # 统计分析页面结构文件
│   │   ├── statistics.wxss     # 统计分析页面样式文件
│   │   └── statistics.js       # 统计分析页面逻辑文件
│   ├── personalSettings/       # 个人设置页面相关文件
│   │   ├── personalSettings.wxml # 个人设置页面结构文件
│   │   ├── personalSettings.wxss # 个人设置页面样式文件
│   │   └── personalSettings.js   # 个人设置页面逻辑文件
├── components/                 # 组件文件夹
│   ├── common/                 # 通用组件
│   │   ├── button/             # 按钮组件
│   │   │   ├── button.wxml     # 按钮结构文件
│   │   │   ├── button.wxss     # 按钮样式文件
│   │   │   └── button.js       # 按钮逻辑文件
│   │   ├── card/               # 卡片组件
│   │   │   ├── card.wxml       # 卡片结构文件
│   │   │   ├── card.wxss       # 卡片样式文件
│   │   │   └── card.js         # 卡片逻辑文件
│   ├── custom/                 # 自定义业务组件
│   │   ├── habitCard/          # 习惯卡片组件
│   │   │   ├── habitCard.wxml  # 习惯卡片结构文件
│   │   │   ├── habitCard.wxss  # 习惯卡片样式文件
│   │   │   └── habitCard.js    # 习惯卡片逻辑文件
│   │   ├── statisticChart/     # 统计图表组件
│   │   │   ├── statisticChart.wxml # 统计图表结构文件
│   │   │   ├── statisticChart.wxss # 统计图表样式文件
│   │   │   └── statisticChart.js   # 统计图表逻辑文件
├── utils/                      # 工具函数文件夹
│   ├── formatDate.js           # 日期格式化工具
│   ├── debounce.js             # 防抖函数
│   ├── throttle.js             # 节流函数
│   └── habitUtils.js           # 习惯相关工具函数，如习惯计算、校验等
├── services/                   # API 请求服务文件夹
│   ├── apiClient.js            # wx.request 实例配置及拦截器设置
│   ├── habitService.js         # 习惯相关的 API 请求
│   ├── userService.js          # 用户相关的 API 请求
│   └── statisticsService.js    # 统计数据相关的 API 请求
├── store/                      # 状态管理文件夹（可使用小程序状态管理库如 MobX-miniprogram 等）
│   ├── index.js                # 状态管理初始化
│   ├── modules/                # 各个模块的状态管理
│   │   ├── userStore.js        # 用户状态管理，存储用户信息、登录状态等
│   │   ├── habitStore.js       # 习惯状态管理，存储习惯列表、习惯详情等
│   │   └── statisticsStore.js  # 统计状态管理，存储统计数据等
├── app.wxss                    # 全局样式文件
├── app.js                      # 应用入口文件，包含小程序生命周期等
└── app.json                    # 小程序全局配置文件，如页面路径、窗口表现等
```

### 2.2 代码质量管控
- **静态检查**：使用ESLint进行代码规范检查，配置适合微信小程序的规则集，如 `eslint-plugin-miniprogram`  ，确保代码语法和风格统一。
- **注释规范**：
  - 组件头部需包含 `@name` `@description` ，说明组件名称和功能。
  - 复杂逻辑需添加 `@logic` 注释，解释逻辑思路。

## 三、核心组件规范
### 3.1 习惯卡片组件（habitCard）
- **核心功能**：
  - 展示习惯名称、目标、完成状态等信息。
  - 支持点击进入习惯详情页面。
  - 显示习惯的打卡记录状态（如已打卡、未打卡）。
- **代码示例**：
```xml
<habit-card :habit="habitItem" @click="goToHabitDetail"></habit-card>
```
```javascript
// habitCard.js
Component({
  properties: {
    habit: {
      type: Object,
      value: {}
    }
  },
  methods: {
    goToHabitDetail() {
      const habitId = this.properties.habit.id;
      wx.navigateTo({
        url: `/pages/habitDetail/habitDetail?id=${habitId}`
      });
    }
  }
})
```

### 3.2 统计图表组件（statisticChart）
- **核心功能**：
  - 根据统计数据生成习惯完成趋势图表（如折线图）。
  - 展示习惯完成情况的百分比统计（如柱状图）。
- **代码示例**：
```xml
<statistic-chart :statisticsData="statisticsData"></statistic-chart>
```
```javascript
// statisticChart.js
Component({
  properties: {
    statisticsData: {
      type: Object,
      value: {}
    }
  },
  ready() {
    // 在此处进行图表绘制逻辑，可使用第三方图表库如wx-charts等
    // 假设已有绘制函数drawChart
    this.drawChart(this.properties.statisticsData);
  },
  methods: {
    drawChart(data) {
      // 具体图表绘制代码
    }
  }
})
```

### 3.3 通用表单组件（用于添加习惯等场景）
- **核心功能**：
  - 支持根据添加习惯的需求动态生成表单，包含习惯名称、频率、提醒时间等字段。
  - 提供表单验证、提交等功能，确保输入数据的合法性。
- **代码示例**：
```xml
<u-form :model="habitFormData">
  <u-form-item label="习惯名称" prop="habitName">
    <u-input v-model="habitFormData.habitName"></u-input>
  </u-form-item>
  <u-form-item label="频率" prop="frequency">
    <u-select v-model="habitFormData.frequency" :options="frequencyOptions"></u-select>
  </u-form-item>
  <u-form-item label="提醒时间" prop="remindTime">
    <u-datetime-picker v-model="habitFormData.remindTime"></u-datetime-picker>
  </u-form-item>
  <u-button type="primary" @click="submitHabitForm">提交</u-button>
</u-form>
```
```javascript
Page({
  data: {
    habitFormData: {
      habitName: '',
      frequency: '',
      remindTime: ''
    },
    frequencyOptions: [
      { label: '每天', value: 'daily' },
      { label: '每周', value: 'weekly' },
      { label: '自定义', value: 'custom' }
    ]
  },
  submitHabitForm() {
    // 表单提交逻辑，验证并调用接口提交习惯数据
    const formData = this.data.habitFormData;
    // 简单验证
    if (!formData.habitName) {
      wx.showToast({
        title: '请输入习惯名称',
        icon: 'none'
      });
      return;
    }
    // 调用接口提交数据
    // 假设已有habitService.js中的addHabit接口
    const habitService = require('../../services/habitService.js');
    habitService.addHabit(formData).then(res => {
      if (res.success) {
        wx.showToast({
          title: '添加习惯成功',
          icon: 'success'
        });
        // 跳转到主页等逻辑
        wx.navigateBack();
      } else {
        wx.showToast({
          title: '添加习惯失败',
          icon: 'none'
        });
      }
    }).catch(err => {
      console.error('添加习惯接口调用失败', err);
      wx.showToast({
        title: '网络错误，请重试',
        icon: 'none'
      });
    });
  }
})
```

## 四、通信机制设计
### 4.1 组件通信矩阵
| 场景              | 方案                          | 典型应用                  |
|-------------------|-------------------------------|--------------------------|
| 父子组件          | `properties`、`events`  | 子组件向父组件传递习惯数据更新，父组件向子组件传值  |
| 跨层级            | `eventBus` （可使用mitt等库实现） | 不同页面组件间的事件通信，如习惯添加成功后通知主页更新  |
| 状态共享          | 小程序状态管理库（如 MobX-miniprogram ） | 用户信息、习惯列表、统计数据等状态共享  |

### 4.2 事件总线实践（以mitt为例）
```javascript
// 初始化总线
const emitter = mitt()

// 统一事件格式
function EventPayload(event, data) {
  return {
    event,
    timestamp: Date.now(),
    data
  }
}

// 安全监听
function listen(event, handler) {
  emitter.on(event, handler)
  // 小程序组件销毁时取消监听
  return () => emitter.off(event, handler)
}
```

### 4.3 接口调用及示例
#### 4.3.1 通用接口调用封装
在 `services/apiClient.js` 中进行通用接口调用的封装：
```javascript
// 配置请求基础地址
const baseURL = 'https://your-api-domain.com/api';

// 封装请求函数
function request(url, method = 'GET', data = {}) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: baseURL + url,
      method,
      data,
      header: {
        'Content-Type': 'application/json'
      },
      success: (res) => {
        if (res.statusCode === 200) {
          resolve(res.data);
        } else {
          reject(res);
        }
      },
      fail: (err) => {
        reject(err);
      }
    });
  });
}

// 导出请求方法
export {
  request
};
```

#### 4.3.2 接口调用例子
- **获取习惯列表接口调用**
在 `home.js` 中调用获取习惯列表接口：
```javascript
import { request } from '../../services/apiClient.js';
import { habitService } from '../../services/habitService.js';

Page({
  data: {
    habitList: []
  },
  onLoad() {
    this.getHabitList();
  },
  async getHabitList() {
    try {
      const response = await habitService.getHabitList();
      this.setData({
        habitList: response.data
      });
    } catch (error) {
      console.error('获取习惯列表失败：', error);
    }
  }
})
```
- **习惯服务接口（habitService.js）示例**
```javascript
import { request } from '../apiClient.js';

const habitService = {
  getHabitList() {
    return request('/habit/list');
  },
  addHabit(data) {
    return request('/habit/add', 'POST', data);
  },
  updateHabit(id, data) {
    return request(`/habit/update/${id}`, 'PUT', data);
  },
  deleteHabit(id) {
    return request(`/habit/delete/${id}`, 'DELETE');
  }
};

export {
  habitService
};
```

## 五、性能优化策略
### 5.1 框架级优化
- **组件优化**：
  - 使用 `wx:if` 和 `hidden` 合理控制组件渲染，避免不必要的渲染开销。例如在习惯详情页面，根据用户是否展开详细打卡记录来决定相关组件的渲染。
  - 对于重复使用的组件，如习惯卡片组件，考虑封装为自定义组件并进行缓存优化，减少重复创建组件的性能消耗。
- **资源加载**：
  - 对图片资源（如有）使用 `image` 组件的 `lazy-load` 属性进行懒加载。
  - 利用小程序的分包加载机制，将代码按功能模块进行分包，如将统计分析相关代码分包，提升首次加载速度。在 `app.json` 中进行分包配置：
```json
{
  "subPackages": [
    {
      "root": "分包路径",
      "pages": [
        "statistics/statistics"
      ]
    }
  ]
}
```

### 5.2 深度性能优化
| 指标           | 优化手段                      | 目标值              |
|----------------|------------------------------|---------------------|
| 首次渲染时间   | 减少页面初始渲染数据量、优化样式计算 | <2s                 |
| 交互延迟       | 合理使用防抖/节流函数、优化事件处理逻辑 | <100ms              |
| 内存占用       | 及时清理不再使用的变量和对象、避免内存泄漏 | <10MB              |

## 六、安全与权限
### 6.1 安全防护
- **请求安全**：
  - 对请求参数进行合法性校验，防止非法参数传入。例如在添加习惯接口中，对习惯名称、频率等参数进行长度、格式等校验。
  - 对敏感数据进行加密传输，如用户登录信息等。使用微信小程序提供的加密接口或第三方加密库进行加密处理。
- **内容安全**：
  - 对用户输入内容进行XSS过滤，防止恶意代码注入。在用户输入习惯名称、描述等内容时，进行过滤处理。
  - 配置合适的CSP（内容安全策略），限制资源加载来源，防止跨站脚本攻击等安全问题。

### 6.2 权限体系
- **用户授权管理**：
  - 对于需要用户授权的功能（如获取用户信息、位置信息等），遵循微信小程序授权流程，引导用户进行授权。例如获取用户头像和昵称用于个人设置展示时，使用 `wx.getUserProfile` 接口并处理授权逻辑。
  - 记录用户授权状态，避免重复询问。将授权状态存储在小程序状态管理中，每次使用相关功能前检查授权状态。
- **页面访问权限**：
  - 在页面跳转前进行权限校验，如判断用户是否登录、是否具备访问特定页面的权限，对于无权限用户进行拦截并提示。例如未登录用户访问个人设置页面时，跳转到登录页面。

## 七、扩展与维护
### 7.1 插件开发
- 若使用第三方插件，需在 `app.json` 中进行插件配置，确保插件正常引入和使用。例如使用图表插件时，按照插件文档进行配置。
- 对于自定义插件开发，遵循微信小程序插件开发规范，将功能进行模块化封装，提供清晰的接口文档以便后续维护和扩展。如开发一个自定义的习惯计算插件，需明确输入输出接口和功能说明。